# Justfile for Cody-Beads Integration
# Modern task runner for the cody-beads-integration package

# Default recipe
default:
    @echo "Cody-Beads Integration"
    @echo ""
    @echo "Available recipes:"
    @echo "  setup        - Setup development environment"
    @echo "  build        - Build the package"
    @echo "  test         - Run all tests"
    @echo "  test:unit    - Run unit tests"
    @echo "  test:integration - Run integration tests"
    @echo "  test:e2e     - Run end-to-end tests"
    @echo "  test:bdd     - Run BDD tests"
    @echo "  test:a11y    - Run accessibility tests"
    @echo "  test:security - Run security tests"
    @echo "  test:performance - Run performance tests"
    @echo "  test:mutation - Run mutation tests"
    @echo "  lint         - Lint code"
    @echo "  lint:fix     - Lint and fix code"
    @echo "  format       - Format code"
    @echo "  type-check   - Type checking"
    @echo "  clean        - Clean build artifacts"
    @echo "  dev          - Start development mode"
    @echo "  publish      - Publish package"
    @echo "  docs         - Generate documentation"

# Environment setup
setup:
    #!/usr/bin/env sh
    echo "ðŸ”§ Setting up cody-beads-integration..."

    # Install dependencies
    echo "ðŸ“¦ Installing dependencies..."
    bun install

    # Setup Git hooks
    echo "ðŸª Setting up Git hooks..."
    bunx husky install

    # Install Playwright browsers
    echo "ðŸŒ Installing Playwright browsers..."
    bunx playwright install

    # Setup development environment
    echo "ðŸ”§ Setting up development environment..."
    cp .env.example .env 2>/dev/null || echo "NODE_ENV=test" > .env

    echo "âœ… Setup completed!"

# Build package
build:
    echo "ðŸ—ï¸ Building cody-beads-integration..."
    bun run build

# Test categories
test:
    just test:unit
    just test:integration
    just test:e2e
    just test:bdd
    just test:a11y
    just test:security

test:unit:
    echo "ðŸ§ª Running unit tests..."
    bun run test:unit

test:integration:
    echo "ðŸ§ª Running integration tests..."
    bun run test:integration

test:e2e:
    echo "ðŸ§ª Running end-to-end tests..."
    bun run test:e2e

test:bdd:
    echo "ðŸ§ª Running BDD tests..."
    bun run test:bdd

test:a11y:
    echo "ðŸ§ª Running accessibility tests..."
    bun run test:a11y

test:security:
    echo "ðŸ”’ Running security tests..."
    bun run test:security

test:performance:
    echo "ðŸ“Š Running performance tests..."
    bun run test:performance

test:mutation:
    echo "ðŸ§¬ Running mutation tests..."
    bun run test:mutation

test:coverage:
    echo "ðŸ“Š Running tests with coverage..."
    bun run test:coverage

test:watch:
    echo "ðŸ‘€ Starting test watch mode..."
    bun run test:watch

# Quality assurance
lint:
    echo "ðŸ” Linting code..."
    bun run lint

lint:fix:
    echo "ðŸ”§ Linting and fixing code..."
    bun run lint:fix

format:
    echo "âœ¨ Formatting code..."
    bun run format

type-check:
    echo "ðŸ” Type checking..."
    bun run type-check

# Development
dev:
    echo "ðŸš€ Starting development mode..."
    bun run dev

dev:test:
    echo "ðŸ§ª Starting development with tests..."
    bun run test:watch

# Quality gates
qa:
    just lint
    just test:coverage
    just type-check
    just test:security
    echo "âœ… All QA checks passed!"

pre-commit:
    just lint
    just test:unit
    just type-check
    echo "âœ… Pre-commit checks passed!"

pre-push:
    just test:all
    echo "âœ… Pre-push checks passed!"

test:all:
    just test:unit
    just test:integration
    just test:e2e
    just test:bdd
    just test:a11y
    just test:security

# Package management
clean:
    echo "ðŸ§¹ Cleaning build artifacts..."
    bun run clean

clean:all:
    echo "ðŸ§¹ Deep clean..."
    bun run clean
    rm -rf node_modules
    rm -rf .nyc_output
    rm -rf coverage
    rm -rf test-results
    rm -rf playwright-report
    rm -rf .stryker-tmp
    rm -rf dist
    rm -rf reports

reset: clean:all
    echo "ðŸ”„ Resetting environment..."
    bun install

# Publishing
publish:
    just build
    just test
    echo "ðŸ“¦ Publishing package..."
    bun publish

publish:dry-run:
    echo "ðŸ“¦ Dry run publishing..."
    bun publish --dry-run

# Release management
version-patch:
    echo "ðŸ·ï¸ Creating patch release..."
    bunx bumpp patch --package="package.json" --commit="chore: Bump version to %s"
    just build
    just publish

version-minor:
    echo "ðŸ·ï¸ Creating minor release..."
    bunx bumpp minor --package="package.json" --commit="feat: Bump version to %s"
    just build
    just publish

version-major:
    echo "ðŸ·ï¸ Creating major release..."
    bunx bumpp major --package="package.json" --commit="feat!: Bump version to %s"
    just build
    just publish

# Documentation
docs:
    echo "ðŸ“š Generating documentation..."
    # Generate API docs
    bun run build
    # Generate type docs
    bunx typedoc src/index.ts --out docs/api
    echo "âœ… Documentation generated!"

docs:serve:
    echo "ðŸŒ Serving documentation..."
    cd docs && bunx http-server . -p 8080

# Configuration
config:setup:
    echo "âš™ï¸ Setting up configuration..."
    bun run bin/liaison.js config setup

config:test:
    echo "ðŸ§ª Testing configuration..."
    bun run bin/liaison.js config test

config:show:
    echo "ðŸ“‹ Showing configuration..."
    bun run bin/liaison.js config show

# Template management
template:list:
    echo "ðŸ“‹ Listing available templates..."
    bun run bin/liaison.js template list

template:create name:
    echo "ðŸ“ Creating template: {{name}}..."
    bun run bin/liaison.js template create {{name}}

template:apply name dest=".":
    echo "ðŸ“¦ Applying template: {{name}} to {{dest}}..."
    bun run bin/liaison.js template apply {{name}} --output-dir {{dest}}

# Synchronization
sync:
    echo "ðŸ”„ Starting synchronization..."
    bun run bin/liaison.js sync

sync:dry-run:
    echo "ðŸ”„ Starting dry run synchronization..."
    bun run bin/liaison.js sync --dry-run

sync:cody-to-beads:
    echo "ðŸ”„ Syncing from Cody to Beads..."
    bun run bin/liaison.js sync --direction cody-to-beads

sync:beads-to-cody:
    echo "ðŸ”„ Syncing from Beads to Cody..."
    bun run bin/liaison.js sync --direction beads-to-cody

# Version management
version:list:
    echo "ðŸ“‹ Listing versions..."
    bun run bin/liaison.js version list

version:add name features description="":
    echo "ðŸ“ Adding version: {{name}}..."
    bun run bin/liaison.js version add --name "{{name}}" --features "{{features}}" --description "{{description}}"

version:build id:
    echo "ðŸ—ï¸ Building version: {{id}}..."
    bun run bin/liaison.js version build {{id}}

version:remove id:
    echo "ðŸ—‘ï¸ Removing version: {{id}}..."
    bun run bin/liaison.js version remove {{id}}

# Security
security:scan:
    echo "ðŸ”’ Running security scan..."
    bun run test:security

security:audit:
    echo "ðŸ”’ Running dependency audit..."
    bunx audit-ci --moderate

security:secrets:
    echo "ðŸ”’ Scanning for secrets..."
    bunx git-secrets --scan

security:all: security:scan security:audit security:secrets
    echo "âœ… All security checks completed!"

# Performance
perf:test:
    echo "ðŸ“Š Running performance tests..."
    bun run test:performance

perf:benchmark:
    echo "ðŸ“Š Running benchmarks..."
    bun run test:performance --benchmark

perf:profile:
    echo "ðŸ“Š Running performance profile..."
    node --prof --trace-events-enabled --trace-event-categories v8,node,node.async_hooks dist/bin/liaison.js --help

# Monitoring
status:
    echo "ðŸ“Š Project status:"
    @echo "Dependencies:"
    @bun pm outdated 2>/dev/null || echo "  All dependencies up to date"
    @echo ""
    @echo "Test status:"
    @bun test:unit --run 2>/dev/null && echo "  âœ… Unit tests pass" || echo "  âŒ Unit tests fail"
    @echo ""
    @echo "Build status:"
    @test -f dist/bin/liaison.js && echo "  âœ… Built" || echo "  âŒ Not built"

health:
    echo "ðŸ¥ Running health checks..."
    @echo "Node.js version: $(node --version)"
    @echo "Bun version: $(bun --version)"
    @echo "TypeScript version: $(tsc --version)"
    @echo ""
    @echo "Dependencies check..."
    @bun test --run 2>/dev/null && echo "âœ… Dependencies OK" || echo "âŒ Dependencies check failed"
    @echo ""
    @echo "Configuration check..."
    @bun run bin/liaison.js config test 2>/dev/null && echo "âœ… Configuration OK" || echo "âŒ Configuration check failed"

# Debugging
debug:tests:
    echo "ðŸ› Debugging tests..."
    LOG_LEVEL=debug bun run test:unit

debug:integration:
    echo "ðŸ› Debugging integration tests..."
    LOG_LEVEL=debug bun run test:integration

debug:e2e:
    echo "ðŸ› Debugging E2E tests..."
    bunx playwright test --debug

# CI/CD helpers
ci:install:
    echo "ðŸ“¦ Installing dependencies for CI..."
    bun install --frozen-lockfile

ci:build:
    echo "ðŸ—ï¸ Building for CI..."
    bun run build

ci:test:
    echo "ðŸ§ª Running tests for CI..."
    bun run test:all

ci:quality:
    echo "ðŸ” Running quality checks for CI..."
    just lint
    just test:coverage
    just type-check
    just security:all

ci:publish:
    echo "ðŸ“¦ Publishing for CI..."
    bun publish --token ${{NPM_TOKEN}}

# Docker
docker:build:
    echo "ðŸ³ Building Docker image..."
    docker build -t cody-beads-integration .

docker:run:
    echo "ðŸ³ Running Docker container..."
    docker run --rm -it cody-beads-integration

# Help
help:
    @echo "Cody-Beads Integration - Just Task Runner"
    @echo ""
    @echo "Development:"
    @echo "  just setup        - Setup development environment"
    @echo "  just dev          - Start development mode"
    @echo "  just build        - Build the package"
    @echo "  just clean        - Clean build artifacts"
    @echo ""
    @echo "Testing:"
    @echo "  just test         - Run all tests"
    @echo "  just test:unit    - Run unit tests"
    @echo "  just test:integration - Run integration tests"
    @echo "  just test:e2e     - Run end-to-end tests"
    @echo "  just test:bdd     - Run BDD tests"
    @echo "  just test:a11y    - Run accessibility tests"
    @echo "  just test:security - Run security tests"
    @echo ""
    @echo "Quality Assurance:"
    @echo "  just lint         - Lint code"
    @echo "  just format       - Format code"
    @echo "  just type-check   - Type checking"
    @echo "  just qa           - Run all QA checks"
    @echo ""
    @echo "Release Management:"
    @echo "  just version-patch - Create patch release"
    @echo "  just version-minor - Create minor release"
    @echo "  just version-major - Create major release"
    @echo "  just publish      - Publish package"
    @echo ""
    @echo "Configuration:"
    @echo "  just config:setup - Setup configuration"
    @echo "  just config:test  - Test configuration"
    @echo "  just config:show  - Show configuration"
    @echo ""
    @echo "Synchronization:"
    @echo "  just sync         - Start synchronization"
    @echo "  just sync:dry-run - Dry run synchronization"
    @echo ""
    @echo "For more recipes, see: just help:detailed"

help:detailed:
    @echo "Cody-Beads Integration - Detailed Help"
    @echo ""
    @echo "All available recipes:"
    @just --list

# Utility recipes
_wait-for-services:
    echo "â³ Waiting for services..."
    @timeout 60 bash -c 'until curl -f http://localhost:3000/health 2>/dev/null; do sleep 2; done'
    @timeout 60 bash -c 'until curl -f http://localhost:3001/health 2>/dev/null; do sleep 2; done'
    echo "âœ… Services ready!"

_create-test-env:
    echo "ðŸ§ª Creating test environment..."
    mkdir -p test-data
    mkdir -p test-data/beads-project
    mkdir -p test-data/github-repos
    mkdir -p test-data/temp
    echo "âœ… Test environment created!"

_cleanup-test-env:
    echo "ðŸ§¹ Cleaning test environment..."
    rm -rf test-data/temp
    echo "âœ… Test environment cleaned!"

# Aliases for convenience
b: build
t: test
l: lint
f: format
d: dev
c: clean
p: publish
h: help