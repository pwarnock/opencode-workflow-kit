# Core Development Commands
# This file contains the essential development workflow commands

# Environment setup
setup:
    #!/usr/bin/env sh
    echo "ğŸ”§ Setting up development environment..."

    # Install uv if not present
    @if ! command -v uv >/dev/null 2>&1; then
        echo "ğŸ“¦ Installing uv..."
        curl -LsSf https://astral.sh/uv/install.sh | sh
    fi

    # Install Bun if not present
    @if ! command -v bun >/dev/null 2>&1; then
        echo "ğŸ“¦ Installing Bun..."
        curl -fsSL https://bun.sh/install | bash
        # Verify installation was successful
        if ! command -v bun >/dev/null 2>&1; then
            echo "âŒ ERROR: Bun installation failed - this is a critical dependency"
            exit 1
        fi
    fi

    # Setup bd (beads) issue tracker
    echo "ğŸ“‹ Setting up bd (beads) issue tracker..."
    @just bd-setup

    # Setup Python environment
    echo "ğŸ Setting up Python environment..."
    @uv sync

    # Setup Node.js environment
    echo "ğŸŸ¨ Setting up Node.js environment..."
    @cd packages/liaison && bun install

    # Setup Git hooks
    echo "ğŸª Setting up Git hooks..."
    @bun run setup:hooks || echo "Hooks setup completed"

    echo "âœ… Development environment ready!"

# Build all packages
build:
    echo "ğŸ—ï¸ Building all packages..."

    # Build opencode-config
    echo "ğŸ“¦ Building opencode-config..."
    @uv run python -m build

    # Build cody-beads-integration
    echo "ğŸ“¦ Building cody-beads-integration..."
    @cd packages/liaison && bun run build

    echo "âœ… All packages built successfully!"

# Test all packages
test: test-python test-node
    echo "âœ… All tests passed!"

# Test Python packages
test-python:
    echo "ğŸ§ª Testing Python packages..."
    @cd packages && uv run pytest --cov=opencode_config --cov-report=term-missing

# Test Node.js packages
test-node:
    echo "ğŸ§ª Testing Node.js packages..."
    @cd packages/liaison && bun run test

# Lint all code
lint: lint-python lint-node
    echo "âœ… All linting completed!"

# Lint Python code
lint-python:
    echo "ğŸ” Linting Python code..."
    @cd packages && uv run ruff check opencode_config/
    @echo "âš ï¸ Skipping mypy type checking due to known issues"

# Lint Node.js code
lint-node:
    echo "ğŸ” Linting Node.js code..."
    @cd packages/liaison && bun run lint

# Format all code
format: format-python format-node
    echo "âœ… All code formatted!"

# Format Python code
format-python:
    echo "âœ¨ Formatting Python code..."
    @cd packages && uv run black opencode_config/
    @cd packages && uv run ruff format opencode_config/

# Format Node.js code
format-node:
    echo "âœ¨ Formatting Node.js code..."
    @cd packages/liaison && bun run format

# Clean build artifacts
clean:
    echo "ğŸ§¹ Cleaning build artifacts..."

    # Python cleanup
    @rm -rf build/
    @rm -rf dist/
    @rm -rf *.egg-info/
    @rm -rf .pytest_cache/
    @rm -rf .coverage
    @rm -rf htmlcov/
    @find . -type d -name __pycache__ -exec rm -rf {} +
    @find . -type f -name "*.pyc" -delete

    # Node.js cleanup
    @cd packages/liaison && \
        rm -rf dist/ && \
        rm -rf node_modules/.cache && \
        rm -rf coverage/ && \
        rm -rf test-results/ && \
        rm -rf playwright-report/ && \
        rm -rf .stryker-tmp/

    echo "âœ… Build artifacts cleaned!"

# Development mode
dev:
    echo "ğŸš€ Starting development mode..."

    # Start Python development server
    @echo "Starting Python development server..." && \
        uv run python -m opencode_config.cli --dev &

    # Start Node.js development server
    @echo "Starting Node.js development server..." && \
        cd packages/liaison && bun run dev &

    echo "âœ… Development servers started!"
    echo "Press Ctrl+C to stop all servers"