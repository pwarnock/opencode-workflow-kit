name: Release and Publish

on:
  workflow_dispatch:
    inputs:
      publish_nodejs:
        description: 'Publish Node.js package'
        required: false
        default: false
        type: boolean
      publish_python:
        description: 'Publish Python package'
        required: false
        default: false
        type: boolean
  push:
    tags:
      - 'v*'

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  packages: write

env:
  NODE_VERSION: '24.11.1'
  PYTHON_VERSION: '3.11'

jobs:
  # Detect and create releases
  detect-release:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      publish-python: ${{ steps.version.outputs.publish-python }}
      publish-nodejs: ${{ steps.version.outputs.publish-nodejs }}
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Extract version
      id: version
      run: |
        VERSION=""

        # Check for version tag
        if [[ "${{ github.ref }}" == refs/tags/* ]]; then
          VERSION="${{ github.ref_name }}"
          echo "Found tag version: $VERSION"
        fi

        # Check for version in commit message
        if [[ -z "$VERSION" ]]; then
          COMMIT_MSG="${{ github.event.head_commit.message }}"
          VERSION=$(echo "$COMMIT_MSG" | grep -oE 'v[0-9]+\.[0-9]+\.[0-9]+' | head -1)
          echo "Found commit version: $VERSION"
        fi

        # Check package.json versions
        if [[ -z "$VERSION" ]]; then
          PYTHON_VERSION=$(cat packages/opencode_config/__init__.py | grep '__version__' | cut -d'"' -f2)
          NODEJS_VERSION=$(cat packages/liaison/package.json | jq -r '.version')
          echo "Python package version: $PYTHON_VERSION"
          echo "Node.js package version: $NODEJS_VERSION"

          # Use the most recent version
          if [ "$PYTHON_VERSION" = "$NODEJS_VERSION" ]; then
            VERSION="v$PYTHON_VERSION"
          else
            VERSION="v$PYTHON_VERSION"
            echo "âš ï¸ Version mismatch between packages"
          fi
        fi

        echo "version=$VERSION" >> $GITHUB_OUTPUT

        # Determine what to publish
        if echo "${{ github.event.head_commit.message }}" | grep -q "\[publish python\]"; then
           echo "publish-python=true" >> $GITHUB_OUTPUT
        fi

        if echo "${{ github.event.head_commit.message }}" | grep -q "\[publish nodejs\]"; then
           echo "publish-nodejs=true" >> $GITHUB_OUTPUT
        fi
        
        if echo "${{ github.event.head_commit.message }}" | grep -q "\[publish all\]"; then
           echo "publish-python=true" >> $GITHUB_OUTPUT
           echo "publish-nodejs=true" >> $GITHUB_OUTPUT
        fi

        # If it's a tag, publish both
        if [[ "${{ github.ref }}" == refs/tags/* ]]; then
          echo "publish-python=true" >> $GITHUB_OUTPUT
          echo "publish-nodejs=true" >> $GITHUB_OUTPUT
        fi

        # Handle workflow_dispatch inputs
        if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
          if [ "${{ github.event.inputs.publish_python }}" == "true" ]; then
            echo "publish-python=true" >> $GITHUB_OUTPUT
          fi
          if [ "${{ github.event.inputs.publish_nodejs }}" == "true" ]; then
            echo "publish-nodejs=true" >> $GITHUB_OUTPUT
          fi
        fi

  # Publish Python package to PyPI
  publish-python:
    needs: detect-release
    runs-on: ubuntu-latest
    if: needs.detect-release.outputs.publish-python == 'true'
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Install uv
      uses: astral-sh/setup-uv@v3

    - name: Configure Git
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"

    - name: Install dependencies
      run: |
        uv sync

    - name: Run tests
      run: |
        uv run python scripts/test-compatibility.py

    - name: Build package
      run: |
        uv build

    - name: Publish to PyPI
      env:
        TWINE_USERNAME: __token__
        TWINE_PASSWORD: ${{ secrets.PYPI_API_TOKEN }}
      run: |
        cd packages/opencode_config
        TWINE_PASSWORD=${{ secrets.PYPI_API_TOKEN }} uv publish

    - name: Create GitHub release for Python
      if: startsWith(needs.detect-release.outputs.version, 'v')
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        VERSION="${{ needs.detect-release.outputs.version }}"
        echo "Creating GitHub release for Python package: $VERSION"

        # Generate release notes
        NOTES="# Liaison Toolkit $VERSION - Python Package

        ## Python Package: OpenCode Config

        This release includes updates to the Python-based configuration and git automation package.

        ### Installation
        \`\`\`bash
        pip install opencode-config==${{ github.run_number }}
        \`\`\`

        ### Features
        - Configuration validation and management
        - Git automation and sync
        - Cross-platform compatibility
        - Schema-based configuration system
        - Comprehensive testing suite

        ### Documentation
        - [README](https://github.com/pwarnock/liaison-toolkit/blob/main/README.md)
        - [CLAUDE.md](https://github.com/pwarnock/liaison-toolkit/blob/main/CLAUDE.md)
        - [Migration Guide](https://github.com/pwarnock/liaison-toolkit/blob/main/MIGRATION_v0.6.0.md)
        - [Configuration Guide](https://github.com/pwarnock/liaison-toolkit/tree/main/docs)

        "

        if gh release view "$VERSION" > /dev/null 2>&1; then
          echo "Release $VERSION already exists, updating notes"
          gh release edit "$VERSION" --notes "$NOTES"
        else
          gh release create "$VERSION" --notes "$NOTES" --title "OpenCode Config $VERSION"
        fi

  # Publish toolkit-core package
  publish-toolkit-core:
    needs: detect-release
    runs-on: ubuntu-latest
    if: needs.detect-release.outputs.publish-nodejs == 'true'
    permissions:
      contents: read
      packages: write
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Bun
      uses: oven-sh/setup-bun@v1
      with:
        bun-version: latest
    
    - name: Configure npm registry
      env:
        NODE_AUTH_TOKEN: ${{ secrets.PAT_GITHUB_TOKEN }}
      run: |
        echo "@pwarnock:registry=https://npm.pkg.github.com" > .npmrc
        echo "//npm.pkg.github.com/:_authToken=${NODE_AUTH_TOKEN}" >> .npmrc

    - name: Configure Git
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"

    - name: Install dependencies
      run: bun install

    - name: Build package
      run: |
        cd packages/core
        bun run build

    - name: Publish to GitHub Packages
      run: |
        cd packages/core
        bun publish
      env:
        NODE_AUTH_TOKEN: ${{ secrets.PAT_GITHUB_TOKEN }}

  # Publish liaison (CLI framework) package
  publish-liaison:
    needs: [detect-release, publish-toolkit-core]
    runs-on: ubuntu-latest
    if: needs.detect-release.outputs.publish-nodejs == 'true'
    permissions:
      contents: read
      packages: write
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Bun
      uses: oven-sh/setup-bun@v1
      with:
        bun-version: latest
    
    - name: Configure npm registry
      env:
        NODE_AUTH_TOKEN: ${{ secrets.PAT_GITHUB_TOKEN }}
      run: |
        echo "@pwarnock:registry=https://npm.pkg.github.com" > .npmrc
        echo "//npm.pkg.github.com/:_authToken=${NODE_AUTH_TOKEN}" >> .npmrc

    - name: Configure Git
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"

    - name: Install dependencies
      run: bun install

    - name: Build package
      run: |
        cd packages/liaison
        bun run build

    - name: Publish to GitHub Packages
      run: |
        cd packages/liaison
        bun publish
      env:
        NODE_AUTH_TOKEN: ${{ secrets.PAT_GITHUB_TOKEN }}

  # Publish liaison-coordinator (sync plugin) package
  publish-liaison-coordinator:
    needs: [detect-release, publish-toolkit-core]
    runs-on: ubuntu-latest
    if: needs.detect-release.outputs.publish-nodejs == 'true'
    permissions:
      contents: read
      packages: write
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Bun
      uses: oven-sh/setup-bun@v1
      with:
        bun-version: latest
    
    - name: Configure npm registry
      env:
        NODE_AUTH_TOKEN: ${{ secrets.PAT_GITHUB_TOKEN }}
      run: |
        echo "@pwarnock:registry=https://npm.pkg.github.com" > .npmrc
        echo "//npm.pkg.github.com/:_authToken=${NODE_AUTH_TOKEN}" >> .npmrc

    - name: Configure Git
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"

    - name: Install dependencies
      run: bun install

    - name: Build package
      run: |
        cd packages/liaison-coordinator
        bun run build

    - name: Publish to GitHub Packages
      run: |
        cd packages/liaison-coordinator
        bun publish
      env:
        NODE_AUTH_TOKEN: ${{ secrets.PAT_GITHUB_TOKEN }}

  # Final Node.js release notification
  publish-nodejs:
    needs: [detect-release, publish-liaison, publish-liaison-coordinator]
    runs-on: ubuntu-latest
    if: needs.detect-release.outputs.publish-nodejs == 'true'
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Bun
      uses: oven-sh/setup-bun@v1
      with:
        bun-version: latest
    
    - name: Configure npm registry for GitHub Packages
      env:
        NODE_AUTH_TOKEN: ${{ secrets.PAT_GITHUB_TOKEN }}
      run: |
        echo "@pwarnock:registry=https://npm.pkg.github.com" > .npmrc
        echo "//npm.pkg.github.com/:_authToken=${NODE_AUTH_TOKEN}" >> .npmrc

    # Using Bun instead of pnpm for consistency

    - name: Configure Git
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"

    - name: Install dependencies
      run: bun install

    - name: Build all packages
      run: bun run build

    - name: Run tests
      run: |
        cd packages/liaison
        bun run test || echo "Tests completed with warnings"

    - name: Create GitHub release for Liaison Toolkit
      if: startsWith(needs.detect-release.outputs.version, 'v')
      env:
        GITHUB_TOKEN: ${{ secrets.PAT_GITHUB_TOKEN }}
      run: |
        VERSION="${{ needs.detect-release.outputs.version }}"
        echo "Creating GitHub release for Liaison Toolkit: $VERSION"

        # Generate release notes
        NOTES="# Liaison Toolkit $VERSION 

        ## ðŸŽ‰ Breaking Change Release: Project Restructuring

        This is a **breaking change release** that restructures the project to better reflect its evolved purpose.

        ### ðŸ“¦ Package Changes

        **@pwarnock/liaison** (v0.6.0)
        - CLI framework for Liaison Toolkit
        - Binary: \`liaison\` (replaces \`opencode\`)
        - Installation: \`npm install @pwarnock/liaison@$VERSION\`

        **@pwarnock/liaison-coordinator** (v0.6.0)
        - Bidirectional sync plugin for Cody-Beads integration
        - Library only (no CLI binary)
        - Installation: \`npm install @pwarnock/liaison-coordinator@$VERSION\`

        **@pwarnock/opencode-config** (v0.6.0)
        - Configuration and git automation
        - Installation: \`pip install opencode-config==$VERSION\`

        ### ðŸ”§ What Users Must Do

        1. **Update Installation:**
           \`\`\`bash
           npm uninstall @pwarnock/toolkit-cli
           npm install @pwarnock/liaison
           \`\`\`

        2. **Update CLI Commands:**
           \`\`\`bash
           opencode init  â†’  liaison init
           opencode sync  â†’  liaison sync
           \`\`\`

        3. **Update Imports:**
           \`\`\`typescript
           import { UnifiedPluginManager } from '@pwarnock/liaison';
           import { coordinatorPlugin } from '@pwarnock/liaison-coordinator';
           \`\`\`

        ### ðŸ“š Documentation

        - [Migration Guide](https://github.com/pwarnock/liaison-toolkit/blob/main/MIGRATION_v0.6.0.md)
        - [Changelog](https://github.com/pwarnock/liaison-toolkit/blob/main/CHANGELOG_v0.6.0.md)
        - [README](https://github.com/pwarnock/liaison-toolkit/blob/main/README.md)
        - [CLAUDE.md](https://github.com/pwarnock/liaison-toolkit/blob/main/CLAUDE.md)

        ### ðŸ™ Breaking Change Rationale

        This restructuring clarifies the project's evolved purpose:
        - Started as configuration management
        - Evolved into workflow automation platform
        - Now separates CLI framework, sync plugin, and config management

        For detailed instructions, see [MIGRATION_v0.6.0.md](https://github.com/pwarnock/liaison-toolkit/blob/main/MIGRATION_v0.6.0.md)

        "

        if gh release view "$VERSION" > /dev/null 2>&1; then
          echo "Release $VERSION already exists, updating notes"
          gh release edit "$VERSION" --notes "$NOTES"
        else
          gh release create "$VERSION" --notes "$NOTES" --title "Liaison Integration $VERSION"
        fi

  # Update monorepo version
  update-version:
    needs: [detect-release, publish-python, publish-nodejs, publish-liaison, publish-liaison-coordinator]
    runs-on: ubuntu-latest
    if: needs.detect-release.outputs.version != ''
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.PAT_GITHUB_TOKEN }}

    - name: Configure Git
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"

    - name: Update versions
      run: |
        VERSION="${{ needs.detect-release.outputs.version }}"
        CLEAN_VERSION="${VERSION#v}"

        # Update all Node.js package.json versions
        for pkg_json in packages/*/package.json; do
          if [ -f "$pkg_json" ]; then
            jq --arg version "$CLEAN_VERSION" '.version = $version' "$pkg_json" > temp.json && mv temp.json "$pkg_json"
            echo "Updated $pkg_json to $CLEAN_VERSION"
          fi
        done

        # Update Python package version
        if [ -f "packages/opencode_config/pyproject.toml" ]; then
          sed -i.bak "s/version = \".*\"/version = \"$CLEAN_VERSION\"/" packages/opencode_config/pyproject.toml
          rm packages/opencode_config/pyproject.toml.bak
          echo "Updated Python package to $CLEAN_VERSION"
        fi

        # Update root package.json version
        jq --arg version "$CLEAN_VERSION" '.version = $version' package.json > temp.json && mv temp.json package.json

        echo "All versions updated to $CLEAN_VERSION"

    - name: Commit version updates
      run: |
        VERSION="${{ needs.detect-release.outputs.version }}"

        git add packages/*/package.json packages/opencode_config/pyproject.toml package.json

        if git diff --staged --quiet; then
          echo "No version changes to commit"
        else
          git commit -m "chore(release): bump version to $VERSION"
          git push origin main
        fi

    - name: Create and push tag
      if: startsWith(needs.detect-release.outputs.version, 'v')
      run: |
        VERSION="${{ needs.detect-release.outputs.version }}"

        # Create tag if it doesn't exist
        if ! git rev-parse "$VERSION" >/dev/null 2>&1; then
          git tag "$VERSION"
          git push origin "$VERSION"
        else
          echo "Tag $VERSION already exists"
        fi