name: Release and Publish

on:
  workflow_dispatch:
  push:
    tags: [ 'v*' ]  # Only version tags trigger releases
  pull_request:
    branches: [ main ]
    types: [ closed ]

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: '24.11.1'
  PYTHON_VERSION: '3.11'

jobs:
  # Detect and create releases
  detect-release:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      publish-python: ${{ steps.version.outputs.publish-python }}
      publish-nodejs: ${{ steps.version.outputs.publish-nodejs }}
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      fetch-depth: 0

    - name: Extract version
      id: version
      run: |
        VERSION=""

        # Check for version tag
        if [[ "${{ github.ref }}" == refs/tags/* ]]; then
          VERSION="${{ github.ref_name }}"
          echo "Found tag version: $VERSION"
        fi

        # Check for version in commit message
        if [[ -z "$VERSION" ]]; then
          COMMIT_MSG="${{ github.event.head_commit.message }}"
          VERSION=$(echo "$COMMIT_MSG" | grep -oE 'v[0-9]+\.[0-9]+\.[0-9]+' | head -1)
          echo "Found commit version: $VERSION"
        fi

        # Check package.json versions
        if [[ -z "$VERSION" ]]; then
          PYTHON_VERSION=$(cat packages/opencode_config/__init__.py | grep '__version__' | cut -d'"' -f2)
          NODEJS_VERSION=$(cat packages/cody-beads-integration/package.json | jq -r '.version')
          echo "Python package version: $PYTHON_VERSION"
          echo "Node.js package version: $NODEJS_VERSION"

          # Use the most recent version
          if [ "$PYTHON_VERSION" = "$NODEJS_VERSION" ]; then
            VERSION="v$PYTHON_VERSION"
          else
            VERSION="v$PYTHON_VERSION"
            echo "⚠️ Version mismatch between packages"
          fi
        fi

        echo "version=$VERSION" >> $GITHUB_OUTPUT

        # Determine what to publish
        if echo "${{ github.event.head_commit.message }}" | grep -q "\[publish python\]"; then
          echo "publish-python=true" >> $GITHUB_OUTPUT
        fi

        if echo "${{ github.event.head_commit.message }}" | grep -q "\[publish nodejs\]"; then
          echo "publish-nodejs=true" >> $GITHUB_OUTPUT
        fi

        # If it's a tag, publish both
        if [[ "${{ github.ref }}" == refs/tags/* ]]; then
          echo "publish-python=true" >> $GITHUB_OUTPUT
          echo "publish-nodejs=true" >> $GITHUB_OUTPUT
        fi

  # Publish Python package to PyPI
  publish-python:
    needs: detect-release
    runs-on: ubuntu-latest
    if: needs.detect-release.outputs.publish-python == 'true'
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Install uv
      uses: astral-sh/setup-uv@v3

    - name: Configure Git
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"

    - name: Install dependencies
      run: |
        cd packages/opencode_config/..
        uv sync

    - name: Run tests
      run: |
        cd packages/opencode_config/..
        uv run python scripts/test-compatibility.py

    - name: Build package
      run: |
        cd packages/opencode_config/..
        uv build

    - name: Publish to PyPI
      env:
        TWINE_USERNAME: __token__
        TWINE_PASSWORD: ${{ secrets.PYPI_API_TOKEN }}
      run: |
        cd packages/opencode_config/..
        uv publish --username __token__ --password ${{ secrets.PYPI_API_TOKEN }}

    - name: Create GitHub release for Python
      if: startsWith(needs.detect-release.outputs.version, 'v')
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        VERSION="${{ needs.detect-release.outputs.version }}"
        echo "Creating GitHub release for Python package: $VERSION"

        # Generate release notes
        NOTES="# OpenCode Config $VERSION

        ## Python Package Changes

        This release includes updates to the Python-based configuration management package.

        ### Installation
        \`\`\`bash
        pip install opencode-config==$VERSION
        \`\`\`

        ### Features
        - Configuration validation and management
        - Cross-platform compatibility
        - Schema-based configuration system
        - Comprehensive testing suite

        ### Documentation
        - [README](https://github.com/pwarnock/opencode-workflow-kit/blob/main/README.md)
        - [CLAUDE.md](https://github.com/pwarnock/opencode-workflow-kit/blob/main/CLAUDE.md)
        - [Configuration Guide](https://github.com/pwarnock/opencode-workflow-kit/tree/main/docs)

        "

        if gh release view "$VERSION" > /dev/null 2>&1; then
          echo "Release $VERSION already exists, updating notes"
          gh release edit "$VERSION" --notes "$NOTES"
        else
          gh release create "$VERSION" --notes "$NOTES" --title "OpenCode Config $VERSION"
        fi

  # Publish Node.js package to GitHub Packages
  publish-nodejs:
    needs: detect-release
    runs-on: ubuntu-latest
    if: needs.detect-release.outputs.publish-nodejs == 'true'
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Bun
      uses: oven-sh/setup-bun@v1
      with:
        bun-version: latest
    
    - name: Configure npm registry for GitHub Packages
      run: |
        echo "@pwarnock:registry=https://npm.pkg.github.com" > .npmrc
        echo "//npm.pkg.github.com/:_authToken=${NODE_AUTH_TOKEN}" >> .npmrc
      env:
        NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    # Using Bun instead of pnpm for consistency

    - name: Configure Git
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"

    - name: Install dependencies
      run: bun install --frozen-lockfile

    - name: Install dependencies
      run: bun install --frozen-lockfile

    - name: Build package
      run: bun run build

    - name: Run tests
      run: bun run test

    - name: Publish to GitHub Packages
      run: |
        cd packages/cody-beads-integration
        bun publish

    - name: Create GitHub release for Node.js
      if: startsWith(needs.detect-release.outputs.version, 'v')
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        VERSION="${{ needs.detect-release.outputs.version }}"
        echo "Creating GitHub release for Node.js package: $VERSION"

        # Generate release notes
        NOTES="# Cody-Beads Integration $VERSION

        ## Node.js Package Changes

        This release includes updates to the Node.js-based Cody-Beads integration package.

        ### Installation
        \`\`\`bash
        npm install @pwarnock/cody-beads-integration@$VERSION
        # or
        bun add @pwarnock/cody-beads-integration@$VERSION
        # or
        bun add @pwarnock/cody-beads-integration@$VERSION
        \`\`\`

        ### Features
        - Seamless Cody-Beads synchronization
        - CLI-based workflow management
        - Conflict resolution strategies
        - Project template system
        - GitHub integration with API client

        ### Usage
        \`\`\`bash
        # Initialize configuration
        cody-beads config setup

        # Synchronize projects
        cody-beads sync

        # Use templates
        cody-beads template create my-project
        \`\`\`

        ### Documentation
        - [README](https://github.com/pwarnock/opencode-workflow-kit/blob/main/README.md)
        - [CLAUDE.md](https://github.com/pwarnock/opencode-workflow-kit/blob/main/CLAUDE.md)
        - [Integration Guide](https://github.com/pwarnock/opencode-workflow-kit/tree/main/docs/CODY_INTEGRATION.md)

        "

        if gh release view "$VERSION" > /dev/null 2>&1; then
          echo "Release $VERSION already exists, updating notes"
          gh release edit "$VERSION" --notes "$NOTES"
        else
          gh release create "$VERSION" --notes "$NOTES" --title "Cody-Beads Integration $VERSION"
        fi

  # Update monorepo version
  update-version:
    needs: [detect-release, publish-python, publish-nodejs]
    runs-on: ubuntu-latest
    if: needs.detect-release.outputs.version != ''
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Configure Git
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"

    - name: Update versions
      run: |
        VERSION="${{ needs.detect-release.outputs.version }}"
        CLEAN_VERSION="${VERSION#v}"

        # Update Python package version
        if [ -f "packages/opencode_config/__init__.py" ]; then
          sed -i.bak "s/__version__ = \".*\"/__version__ = \"$CLEAN_VERSION\"/" packages/opencode_config/__init__.py
          rm packages/opencode_config/__init__.py.bak
        fi

        # Update Node.js package version
        if [ -f "packages/cody-beads-integration/package.json" ]; then
          # Use jq to update package.json version
          jq --arg version "$CLEAN_VERSION" '.version = $version' packages/cody-beads-integration/package.json > temp.json && mv temp.json packages/cody-beads-integration/package.json
        fi

        # Update root package.json version
        jq --arg version "$CLEAN_VERSION" '.version = $version' package.json > temp.json && mv temp.json package.json

        echo "Updated version to $VERSION"

    - name: Commit version updates
      run: |
        VERSION="${{ needs.detect-release.outputs.version }}"

        git add packages/opencode_config/__init__.py packages/cody-beads-integration/package.json package.json

        if git diff --staged --quiet; then
          echo "No version changes to commit"
        else
          git commit -m "chore: update version to $VERSION"
          git push
        fi

    - name: Create and push tag
      if: startsWith(needs.detect-release.outputs.version, 'v')
      run: |
        VERSION="${{ needs.detect-release.outputs.version }}"

        # Create tag if it doesn't exist
        if ! git rev-parse "$VERSION" >/dev/null 2>&1; then
          git tag "$VERSION"
          git push origin "$VERSION"
        else
          echo "Tag $VERSION already exists"
        fi